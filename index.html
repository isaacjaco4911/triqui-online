<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, 1.0, maximum-scale=1.0, user-scalable=no">
  <title>Triqui By Isaac</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    
    .contenedor-juego {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      width: 100%;
      max-width: 600px;
    }

    h1 {
      font-size: clamp(1.5rem, 4vw, 2rem);
      text-align: center;
    }
    
    .tablero {
      position: relative;
      width: min(300px, 90vw);
      height: min(450px, 135vw);
      background-color: #fff;
      border: 3px solid #333;
      overflow: visible; /* Permitir que las fichas en los bordes se vean completas */
    }
    
    .linea {
      position: absolute;
      background-color: #333;
      z-index: 1;
    }
    
    .horizontal {
      width: 100%;
      height: 4px;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
    }
    
    .vertical {
      width: 4px;
      height: 100%;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
    }
    
    .diagonal1 {
      width: 4px;
      height: 540px;
      left: 50%;
      top: 50%;
      transform-origin: center;
      transform: translate(-50%, -50%) rotate(34deg);
    }
    
    .diagonal2 {
      width: 4px;
      height: 540px;
      left: 50%;
      top: 50%;
      transform-origin: center;
      transform: translate(-50%, -50%) rotate(-34deg);
    }
    
    .jugadores {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    @media (min-width: 768px) {
      .jugadores {
        flex-direction: row;
        justify-content: space-between;
      }
    }
    
    .jugador {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .fichas-contenedor {
      display: flex;
      gap: 10px;
    }
    
    .ficha {
      width: min(40px, 12vw);
      height: min(40px, 12vw);
      border-radius: 50%;
      border: 2px solid #333;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      user-select: none;
      font-size: clamp(14px, 4vw, 18px);
    }
    
    .ficha-seleccionada {
      box-shadow: 0 0 0 3px gold;
    }
    
    .jugador-1 .ficha {
      background-color: #e74c3c;
    }
    
    .jugador-2 .ficha {
      background-color: #3498db;
    }
    
    .selector-color {
      margin-top: 5px;
    }
    
    .posicion {
      position: absolute;
      width: min(60px, 18vw);
      height: min(60px, 18vw);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }
    
    .posicion:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .posicion-valida {
      background-color: rgba(46, 204, 113, 0.2);
    }
    
    .posicion-seleccionada {
      background-color: rgba(241, 196, 15, 0.3);
    }
    
    .sin-movimientos {
      background-color: rgba(231, 76, 60, 0.2);
    }
    
    .ficha-tablero {
      width: min(50px, 15vw);
      height: min(50px, 15vw);
      border-radius: 50%;
      border: 2px solid #333;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #fff;
      font-size: clamp(16px, 4.5vw, 20px);
    }
    
    .ficha-tablero[data-forma="star"] {
      /* Styles to make the div look like a star */
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      border-radius: 0;
    }

    .ficha-tablero[data-forma="triangle"] {
      /* Styles to make the div look like a triangle */
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      border-radius: 0;
    }
    
    .mensaje {
      height: 30px;
      font-weight: bold;
      color: #333;
      text-align: center;
      font-size: clamp(14px, 4vw, 16px);
    }
    
    .estado-juego {
      margin-top: 10px;
      text-align: center;
      font-style: italic;
      font-size: clamp(14px, 4vw, 16px);
    }
    
    .reiniciar {
      padding: 8px 16px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: none; /* Ocultar por defecto */
    }
    
    .reiniciar:hover {
      background-color: #555;
    }
    
    h1 {
      margin-bottom: 10px;
    }
    
    /* Estilos para la secci贸n de conexi贸n */
    .conexion-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      width: 100%;
      max-width: 500px;
      padding: 15px;
      box-sizing: border-box;
    }
    
    .conexion-opciones {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 8px 16px;
      background-color: #3498db;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .btn:hover {
      background-color: #2980b9;
    }
    
    .btn-copiar {
      background-color: #2ecc71;
    }
    
    .btn-copiar:hover {
      background-color: #27ae60;
    }
    
    .codigo-sala {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      padding: 5px 10px;
      border: 1px dashed #aaa;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    
    .input-codigo {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
      width: min(200px, 80vw);
      text-align: center;
    }
    
    .espectador-badge {
      background-color: #f39c12;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    .juego-container {
      display: none;
    }
    
    .conexion-mensaje {
      color: #e74c3c;
      font-weight: bold;
      height: 20px;
    }
    
    .jugador-info {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .jugador-online {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #2ecc71;
    }
    
    .jugador-offline {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #e74c3c;
    }

    /* Estilos para auth */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      width: 100%;
      max-width: 500px;
      padding: 15px;
      box-sizing: border-box;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 300px;
    }

    .auth-input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .auth-toggle {
      color: #3498db;
      cursor: pointer;
      text-decoration: underline;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Estilos para estad铆sticas y ranking */
    .stats-container {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      padding: 15px;
      box-sizing: border-box;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .stat-item {
      text-align: center;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }

    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: clamp(12px, 3.5vw, 16px);
    }

    .ranking-table th,
    .ranking-table td {
      padding: min(8px, 2vw);
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .ranking-table th {
      background-color: #f5f6fa;
      font-weight: bold;
    }

    .ranking-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .ranking-table tr:hover {
      background-color: #f1f2f6;
    }

    .timer {
      font-size: clamp(14px, 4vw, 18px);
    }

    /* Estilos para chat y emotes */
    .chat-container {
      width: 100%;
      max-width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 20px;
      display: none;
    }

    .chat-messages {
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .chat-message {
      margin-bottom: 8px;
      font-size: 14px;
    }

    .chat-input {
      display: flex;
      padding: 10px;
      gap: 8px;
    }

    .chat-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .emotes-container {
      display: flex;
      gap: 8px;
      padding: 8px;
      border-top: 1px solid #eee;
    }

    .emote-btn {
      font-size: 20px;
      padding: 4px 8px;
      border: none;
      background: #f0f0f0;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .emote-btn:hover {
      transform: scale(1.1);
    }

    .emote-popup {
      position: fixed;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s;
      z-index: 1000;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Media query ajustado */
    @media (max-width: 480px) {
      .conexion-opciones {
        flex-direction: column;
        gap: 10px;
      }

      .btn {
        width: 100%;
      }

      .selector-color,
      .selector-forma {
        width: 100%;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="contenedor-juego">
    <h1>Triqui By Isaac</h1>

    <!-- Auth Container -->
    <div class="auth-container" id="auth-container">
      <div class="user-info" id="user-info" style="display: none;">
        <span>Bienvenido, <span id="username-display"></span></span>
        <button class="btn" id="logout-btn">Cerrar sesi贸n</button>
      </div>

      <form class="auth-form" id="auth-form">
        <input type="text" class="auth-input" id="username" placeholder="Nombre de usuario">
        <input type="email" class="auth-input" id="email" placeholder="Correo electr贸nico" required>
        <input type="password" class="auth-input" id="password" placeholder="Contrase帽a" required>
        <button type="submit" class="btn" id="auth-submit">Registrarse</button>
        <span class="auth-toggle" id="auth-toggle">驴Ya tienes cuenta? Inicia sesi贸n</span>
      </form>
    </div>
    
    <!-- Contenedor de conexi贸n -->
    <div class="conexion-container" id="conexion-container">
      <h2>Conectarse a una partida</h2>
      
      <div class="conexion-opciones" id="conexion-opciones">
        <button class="btn" id="crear-sala">Crear sala</button>
        <button class="btn" id="unirse-sala">Unirse a sala</button>
      </div>
      
      <div id="sala-creada" style="display: none;">
        <p>Comparte este c贸digo con tu oponente:</p>
        <div class="codigo-sala" id="codigo-sala"></div>
        <button class="btn btn-copiar" id="copiar-codigo">Copiar c贸digo</button>
      </div>
      
      <div id="unirse-form" style="display: none;">
        <p>Introduce el c贸digo de la sala:</p>
        <input type="text" class="input-codigo" id="input-codigo" placeholder="C贸digo de sala">
        <button class="btn" id="btn-unirse">Unirse</button>
      </div>
      
      <div class="conexion-mensaje" id="conexion-mensaje"></div>
    </div>
    
    <!-- Contenedor del juego (oculto inicialmente) -->
    <div class="juego-container" id="juego-container">
      <div class="jugadores">
        <div class="jugador jugador-2">
          <div class="jugador-info">
            <h2>Jugador 2</h2>
            <div id="jugador-2-status" class="jugador-offline"></div>
            <span id="jugador-2-espectador" class="espectador-badge" style="display: none;">Espectador</span>
          </div>
          <div class="fichas-contenedor" id="fichas-jugador-2">
            <div class="ficha" data-id="2-1">1</div>
            <div class="ficha" data-id="2-2">2</div>
            <div class="ficha" data-id="2-3">3</div>
          </div>
          <input type="color" class="selector-color" id="color-jugador-2" value="#3498db">
          <select class="selector-forma" id="forma-jugador-2">
            <option value="circle">C铆rculo</option>
            <option value="star">Estrella</option>
            <option value="triangle">Tri谩ngulo</option>
          </select>
        </div>
        
        <div class="jugador jugador-1">
          <div class="jugador-info">
            <h2>Jugador 1</h2>
            <div id="jugador-1-status" class="jugador-offline"></div>
            <span id="jugador-1-espectador" class="espectador-badge" style="display: none;">Espectador</span>
          </div>
          <div class="fichas-contenedor" id="fichas-jugador-1">
            <div class="ficha" data-id="1-1">1</div>
            <div class="ficha" data-id="1-2">2</div>
            <div class="ficha" data-id="1-3">3</div>
          </div>
          <input type="color" class="selector-color" id="color-jugador-1" value="#e74c3c">
          <select class="selector-forma" id="forma-jugador-1">
            <option value="circle">C铆rculo</option>
            <option value="star">Estrella</option>
            <option value="triangle">Tri谩ngulo</option>
          </select>
        </div>
      </div>
      
      <div class="mensaje" id="mensaje">Esperando jugadores...</div>
      <div class="estado-juego" id="estado-juego">Fase de colocaci贸n: coloca tus 3 fichas</div>
      <div class="timer" id="timer">Tiempo restante: 30</div>
      
      <div class="tablero" id="tablero">
        <div class="linea horizontal"></div>
        <div class="linea vertical"></div>
        <div class="linea diagonal1"></div>
        <div class="linea diagonal2"></div>
        
        <!-- Posiciones para las fichas (9 posiciones) -->
        <!-- Esquinas del cuadrado -->
        <div class="posicion" style="left: 30px; top: 30px;" data-pos="0"></div>
        <div class="posicion" style="left: 270px; top: 30px;" data-pos="1"></div>
        <div class="posicion" style="left: 30px; top: 420px;" data-pos="2"></div>
        <div class="posicion" style="left: 270px; top: 420px;" data-pos="3"></div>
        
        <!-- Puntas de las l铆neas que tocan los bordes -->
        <div class="posicion" style="left: 150px; top: 30px;" data-pos="4"></div>
        <div class="posicion" style="left: 30px; top: 225px;" data-pos="5"></div>
        <div class="posicion" style="left: 270px; top: 225px;" data-pos="6"></div>
        <div class="posicion" style="left: 150px; top: 420px;" data-pos="7"></div>
        
        <!-- Centro donde se cruzan todas las l铆neas -->
        <div class="posicion" style="left: 150px; top: 225px;" data-pos="8"></div>
      </div>
      
      <button class="reiniciar" id="reiniciar">Reiniciar Juego</button>

      <!-- Chat y emotes -->
      <div class="chat-container" id="chat-container">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="chat-input" placeholder="Escribe un mensaje...">
          <button class="btn" id="chat-send">Enviar</button>
        </div>
        <div class="emotes-container">
          <button class="emote-btn" data-emote=""></button>
          <button class="emote-btn" data-emote=""></button>
          <button class="emote-btn" data-emote=""></button>
          <button class="emote-btn" data-emote=""></button>
          <button class="emote-btn" data-emote=""></button>
          <button class="emote-btn" data-emote=""></button>
        </div>
      </div>
    </div>

    <!-- Contenedor de estad铆sticas -->
    <div class="stats-container" id="stats-container" style="display: none;">
      <h2>Mis Estad铆sticas</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="stats-victories">0</div>
          <div class="stat-label">Victorias</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stats-defeats">0</div>
          <div class="stat-label">Derrotas</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stats-avg-time">0s</div>
          <div class="stat-label">Tiempo Promedio</div>
        </div>
      </div>
      
      <h3>Ranking Global</h3>
      <table class="ranking-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Jugador</th>
            <th>Victorias</th>
            <th>Derrotas</th>
            <th>Ratio</th>
          </tr>
        </thead>
        <tbody id="ranking-table-body">
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const firebaseConfig = {
        apiKey: "AIzaSyAuFf8nPRINetfubh1MIEb9Dv4NuQvn6_A",
        authDomain: "cloudflare-3098a.firebaseapp.com",
        databaseURL: "https://cloudflare-3098a-default-rtdb.firebaseio.com/",
        projectId: "cloudflare-3098a",
        storageBucket: "cloudflare-3098a.firebasestorage.app",
        messagingSenderId: "985997253869",
        appId: "1:985997253869:web:ae57f49db56dec7d1d00e4"
      };
      
      // Inicializar Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const auth = firebase.auth();

      // Referencias al DOM
      const juegoContainer = document.getElementById('juego-container');
      const authContainer = document.getElementById('auth-container');
      const authForm = document.getElementById('auth-form');
      const authToggle = document.getElementById('auth-toggle');
      const authSubmit = document.getElementById('auth-submit');
      const userInfo = document.getElementById('user-info');
      const usernameDisplay = document.getElementById('username-display');
      const logoutBtn = document.getElementById('logout-btn');
      const conexionContainer = document.getElementById('conexion-container');

      let isLogin = false;

      // Toggle entre login y registro
      authToggle.addEventListener('click', () => {
        isLogin = !isLogin;
        authSubmit.textContent = isLogin ? 'Iniciar sesi贸n' : 'Registrarse';
        authToggle.textContent = isLogin ? '驴No tienes cuenta? Reg铆strate' : '驴Ya tienes cuenta? Inicia sesi贸n';
        const usernameInput = document.getElementById('username');
        usernameInput.style.display = isLogin ? 'none' : 'block';
        usernameInput.required = !isLogin;
      });

      // Manejar registro/login
      authForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const username = document.getElementById('username').value;

        if (isLogin) {
          // Login
          auth.signInWithEmailAndPassword(email, password)
            .catch(error => {
              alert('Error: ' + error.message);
            });
        } else {
          // Registro
          auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
              // Guardar username en Realtime Database
              return database.ref('users/' + userCredential.user.uid).set({
                username: username
              });
            })
            .catch(error => {
              alert('Error: ' + error.message);
            });
        }
      });

      // Manejar logout
      logoutBtn.addEventListener('click', () => {
        // Desconectar listeners si hay una sala activa
        if (salaId) {
          database.ref('salas/' + salaId + '/estado').off();
          database.ref('salas/' + salaId + '/jugadores').off();
          
          // Si es jugador, marcar como desconectado
          if (jugadorNum === 1 || jugadorNum === 2) {
            database.ref('salas/' + salaId + '/jugadores/' + jugadorNum + '/conectado').set(false);
          }
        }

        // Limpiar URL
        window.history.pushState({}, '', window.location.pathname);
        
        // Reiniciar variables
        salaId = null;
        jugadorNum = null;
        miTurno = false;
        esEspectador = false;
        
        // Cerrar sesi贸n
        auth.signOut();
      });

      // Observer de estado de autenticaci贸n
      auth.onAuthStateChanged((user) => {
        if (user) {
          database.ref('users/' + user.uid).once('value')
            .then(snapshot => {
              const userData = snapshot.val();
              if (userData && userData.username) {
                usernameDisplay.textContent = userData.username;
                authForm.style.display = 'none';
                userInfo.style.display = 'flex';
                conexionContainer.style.display = 'block';
                document.getElementById('stats-container').style.display = 'block';
                initializeUserStats(user.uid);
                loadUserStats(user.uid);
                updateRankingTable();
                
                // Solo unirse a sala desde URL si no hay sala activa
                if (!salaId) {
                  const urlParams = new URLSearchParams(window.location.search);
                  const salaIdFromUrl = urlParams.get('sala');
                  if (salaIdFromUrl) {
                    unirseASala(salaIdFromUrl);
                  }
                }
              }
            });
        } else {
          // Usuario no autenticado
          authForm.style.display = 'flex';
          userInfo.style.display = 'none';
          conexionContainer.style.display = 'none';
          juegoContainer.style.display = 'none';
          document.getElementById('stats-container').style.display = 'none';
          
          // Desconectar listeners si hay una sala activa
          if (salaId) {
            database.ref('salas/' + salaId + '/estado').off();
            database.ref('salas/' + salaId + '/jugadores').off();
          }
          
          // Reiniciar variables
          salaId = null;
          jugadorNum = null;
          miTurno = false;
          esEspectador = false;
          
          // Limpiar URL
          window.history.pushState({}, '', window.location.pathname);
        }
      });

      // Resto del c贸digo del juego
      // Variables para la conexi贸n
      let salaId = null;
      let jugadorNum = null;
      let miTurno = false;
      let esEspectador = false;
      
      // Referencias al DOM para la conexi贸n
      const crearSalaBtn = document.getElementById('crear-sala');
      const unirseSalaBtn = document.getElementById('unirse-sala');
      const salaCreada = document.getElementById('sala-creada');
      const unirseForm = document.getElementById('unirse-form');
      const codigoSala = document.getElementById('codigo-sala');
      const inputCodigo = document.getElementById('input-codigo');
      const btnUnirse = document.getElementById('btn-unirse');
      const copiarCodigoBtn = document.getElementById('copiar-codigo');
      const conexionMensaje = document.getElementById('conexion-mensaje');
      const conexionOpciones = document.getElementById('conexion-opciones');
      const jugador1Status = document.getElementById('jugador-1-status');
      const jugador2Status = document.getElementById('jugador-2-status');
      const jugador1Espectador = document.getElementById('jugador-1-espectador');
      const jugador2Espectador = document.getElementById('jugador-2-espectador');
      
      // Variables del juego
      let turnoJugador = 1;
      let fichaSeleccionada = null;
      let posicionSeleccionada = null;
      let ganador = null;
      let tablero = Array(9).fill(null);
      let faseMover = false; // False = fase de colocaci贸n, True = fase de mover
      let fichasColocadasJ1 = 0;
      let fichasColocadasJ2 = 0;
      
      // Mapa de adyacencia (conectividad entre posiciones)
      const mapaAdyacencia = {
        0: [4, 5, 8], // Esquina superior izquierda
        1: [4, 6, 8], // Esquina superior derecha
        2: [5, 7, 8], // Esquina inferior izquierda
        3: [6, 7, 8], // Esquina inferior derecha
        4: [0, 1, 8], // Centro superior
        5: [0, 2, 8], // Centro izquierdo
        6: [1, 3, 8], // Centro derecho
        7: [2, 3, 8], // Centro inferior
        8: [0, 1, 2, 3, 4, 5, 6, 7] // Centro (conecta con todas)
      };
      
      // Combinaciones ganadoras (posiciones del tablero)
      const combinacionesGanadoras = [
        [0, 4, 1],   // Horizontal superior
        [5, 8, 6],   // Horizontal medio
        [2, 7, 3],   // Horizontal inferior
        [0, 5, 2],   // Vertical izquierda
        [4, 8, 7],   // Vertical medio
        [1, 6, 3],   // Vertical derecha
        [0, 8, 3],   // Diagonal principal
        [1, 8, 2]    // Diagonal secundaria
      ];
      
      // Referencias a elementos del DOM del juego
      const mensaje = document.getElementById('mensaje');
      const estadoJuego = document.getElementById('estado-juego');
      const fichasJugador1 = document.getElementById('fichas-jugador-1').querySelectorAll('.ficha');
      const fichasJugador2 = document.getElementById('fichas-jugador-2').querySelectorAll('.ficha');
      const colorJugador1 = document.getElementById('color-jugador-1');
      const colorJugador2 = document.getElementById('color-jugador-2');
      const formaJugador1 = document.getElementById('forma-jugador-1');
      const formaJugador2 = document.getElementById('forma-jugador-2');
      const btnReiniciar = document.getElementById('reiniciar');
      const posicionesTablero = document.querySelectorAll('.posicion');
      
      // Timer variables
      const timerDisplay = document.getElementById('timer');
      let timeLeft = 30;
      let timerInterval;
      
      // Generar ID 煤nico para la sala
      function generarSalaId() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
      }
      
      // Crear una nueva sala
      function crearSala() {
        if (!auth.currentUser) return;

        salaId = generarSalaId();
        jugadorNum = 1;
        miTurno = true;
        esEspectador = false;

        // Agregar el ID de la sala a la URL
        const newUrl = `${window.location.pathname}?sala=${salaId}`;
        window.history.pushState({}, '', newUrl);

        database.ref('users/' + auth.currentUser.uid).once('value')
          .then(snapshot => {
            const userData = snapshot.val();
            const estadoInicial = {
              turnoJugador: 1,
              tablero: Array(9).fill(null), // Usar array nuevo en lugar de variable global
              faseMover: false,
              fichasColocadasJ1: 0,
              fichasColocadasJ2: 0,
              ganador: null,
              terminada: false  // Agregar este campo
            };

            return database.ref('salas/' + salaId).set({
              estado: estadoInicial,
              jugadores: {
                1: {
                  conectado: true,
                  color: colorJugador1.value,
                  espectador: false,
                  forma: formaJugador1.value,
                  uid: auth.currentUser.uid,
                  username: userData.username
                },
                2: {
                  conectado: false,
                  color: colorJugador2.value,
                  espectador: false,
                  forma: formaJugador2.value
                }
              }
            });
          });

        // Configurar desconexi贸n
        database.ref('salas/' + salaId + '/jugadores/1/conectado').onDisconnect().set(false);
        
        // Mostrar c贸digo de sala
        codigoSala.textContent = salaId;
        conexionOpciones.style.display = 'none';
        salaCreada.style.display = 'block';
        
        // Listener para detectar conexi贸n del jugador 2
        database.ref('salas/' + salaId + '/jugadores').on('value', (snapshot) => {
            const jugadores = snapshot.val();
            if (jugadores && jugadores[2]?.conectado) {
                // Ocultar UI de conexi贸n y mostrar juego
                conexionContainer.style.display = 'none';
                juegoContainer.style.display = 'block';
                conectarseASala();
            }
        });
      }
      
      // Unirse a una sala existente
      function unirseASala(codigo) {
        if (!auth.currentUser) return;

        salaId = codigo.toUpperCase();
        
        database.ref('salas/' + salaId).once('value').then((snapshot) => {
            if (!snapshot.exists()) {
                conexionMensaje.textContent = "La sala no existe. Verifica el c贸digo.";
                return;
            }

            const data = snapshot.val();
            
            // Verificar si la sala est谩 llena
            if (data.jugadores[2]?.conectado) {
                // Modo espectador
                jugadorNum = 3;
                esEspectador = true;
                miTurno = false;
            } else {
                // Unirse como jugador 2
                jugadorNum = 2;
                esEspectador = false;
            }

            // Actualizar UI y conectarse
            conexionContainer.style.display = 'none';
            juegoContainer.style.display = 'block';
            mensaje.textContent = esEspectador ? "Est谩s observando la partida" : "Te has unido a la partida";
            
            // Si no es espectador, actualizar informaci贸n del jugador
            if (!esEspectador) {
                database.ref('users/' + auth.currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        return database.ref('salas/' + salaId + '/jugadores/2').update({
                            conectado: true,
                            color: colorJugador2.value,
                            espectador: false,
                            forma: formaJugador2.value,
                            uid: auth.currentUser.uid,
                            username: userData.username
                        });
                    });
            }
            
            // Agregar el ID de la sala a la URL si no est谩 ya
            if (!window.location.search.includes(salaId)) {
                const newUrl = `${window.location.pathname}?sala=${salaId}`;
                window.history.pushState({}, '', newUrl);
            }
            
            conectarseASala();
        }).catch((error) => {
            conexionMensaje.textContent = "Error al unirse a la sala";
        });
      }
      
      // Conectarse a una sala y configurar listeners
      function conectarseASala() {
        // Verificar si la sala est谩 terminada
        database.ref('salas/' + salaId + '/estado/terminada').once('value', (snapshot) => {
            if (snapshot.val()) {
                conexionMensaje.textContent = "Esta sala ha sido terminada.";
                conexionContainer.style.display = 'block';
                juegoContainer.style.display = 'none';
                salaId = null;
                jugadorNum = null;
                return;
            }
            
            // Configurar listeners del estado del juego
            const estadoRef = database.ref('salas/' + salaId + '/estado');
            estadoRef.on('value', (snapshot) => {
                const estado = snapshot.val();
                if (estado) actualizarEstadoJuego(estado);
            });

            // Listener para jugadores
            const jugadoresRef = database.ref('salas/' + salaId + '/jugadores');
            jugadoresRef.on('value', (snapshot) => {
                const jugadores = snapshot.val();
                if (jugadores) actualizarEstadoJugadores(jugadores);
            });

            // Iniciar l贸gica del juego
            iniciarJuego();

            // Mostrar chat cuando se conecta a la sala
            document.getElementById('chat-container').style.display = 'block';

            // Configurar chat y emotes
            setupChatAndEmotes();
        });
      }
      
      // Update timer display
      function updateTimerDisplay() {
        timerDisplay.textContent = `Tiempo restante: ${timeLeft}`;
      }
      
      // Start timer
      function startTimer() {
        clearInterval(timerInterval);
        timeLeft = 30;
        updateTimerDisplay();
        
        // Solo iniciar el temporizador si ambos jugadores est谩n conectados
        if (jugador1Status.classList.contains('jugador-online') && 
            jugador2Status.classList.contains('jugador-online')) {
          timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
              clearInterval(timerInterval);
              timeOutTurn();
            }
          }, 1000);
        }
      }
      
      // Function when time runs out
      function timeOutTurn() {
        if (ganador) return;
        
        // Cambiar turno
        turnoJugador = turnoJugador === 1 ? 2 : 1;
        
        // Si el siguiente jugador no tiene movimientos v谩lidos, regresa el turno
        if (faseMover && !verificarFichasConMovimientos()) {
          // Solo anunciar esto si ambos jugadores est谩n conectados
          if (jugador1Status.classList.contains('jugador-online') && 
              jugador2Status.classList.contains('jugador-online')) {
            mensaje.textContent = `隆Jugador ${turnoJugador} sin movimientos v谩lidos! Turno de Jugador ${turnoJugador === 1 ? 2 : 1}`;
            setTimeout(() => {
              turnoJugador = turnoJugador === 1 ? 2 : 1;
              mensaje.textContent = `Turno del Jugador ${turnoJugador}`;
              sincronizarEstadoJuego();
            }, 2000);
            return;
          }
        }
        
        sincronizarEstadoJuego();
      }
      
      // Actualizar estado del juego desde Firebase
      function actualizarEstadoJuego(estado) {
        if (!estado) {
          console.error("Estado del juego es undefined");
          return;
        }

        // Convertir el tablero de objeto a arreglo
        const tableroData = estado.tablero;
        const nuevoTablero = Array(9).fill(null);
        if (tableroData) {
          for (let i = 0; i < 9; i++) {
            nuevoTablero[i] = tableroData[i] || null;
          }
        }

        // Actualizar variables locales
        turnoJugador = estado.turnoJugador || 1;
        tablero = nuevoTablero;
        faseMover = estado.faseMover || false;
        fichasColocadasJ1 = estado.fichasColocadasJ1 || 0;
        fichasColocadasJ2 = estado.fichasColocadasJ2 || 0;
        ganador = estado.ganador || null;
        
        // Actualizar mensaje de turno
        if (ganador) {
          mensaje.textContent = `隆Jugador ${ganador} ha ganado!`;
          document.getElementById('estado-juego').textContent = "Juego terminado";
          btnReiniciar.style.display = 'block'; // Mostrar bot贸n cuando hay ganador
        } else {
          mensaje.textContent = `Turno del Jugador ${turnoJugador}`;
          if (faseMover) {
            document.getElementById('estado-juego').textContent = "Fase de movimiento: mueve fichas a posiciones adyacentes";
          } else {
            document.getElementById('estado-juego').textContent = "Fase de colocaci贸n: coloca tus 3 fichas";
          }
          btnReiniciar.style.display = 'none'; // Ocultar bot贸n mientras se juega
        }
        
        // Verificar si es mi turno
        miTurno = !esEspectador && turnoJugador === jugadorNum;
        
        // Limpiar tablero y selecci贸n
        limpiarSeleccionPosicion();
        posicionesTablero.forEach(posicion => {
          posicion.innerHTML = '';
        });
        
        if (fichaSeleccionada) {
          fichaSeleccionada.classList.remove('ficha-seleccionada');
          fichaSeleccionada = null;
        }
        
        // Restaurar fichas en la mano
        const todasLasFichas = document.querySelectorAll('.ficha');
        todasLasFichas.forEach(ficha => {
          ficha.style.opacity = '1';
          ficha.classList.remove('ficha-en-tablero', 'ficha-seleccionada', 'sin-movimientos');
        });
        
        // Limpiar fichas existentes en el tablero
        posicionesTablero.forEach(posicion => {
          posicion.innerHTML = '';
        });

        // Colocar fichas en el tablero seg煤n el estado
        for (let i = 0; i < tablero.length; i++) {
          if (tablero[i] === null) continue;
          
          const pos = i;
          const fichaId = tablero[i];
          const jugadorFicha = parseInt(fichaId.split('-')[0]);
          const fichaNum = parseInt(fichaId.split('-')[1]);
          const color = jugadorFicha === 1 ? colorJugador1.value : colorJugador2.value;
          
          // Crear ficha en el tablero
          const fichaTablero = document.createElement('div');
          fichaTablero.className = 'ficha-tablero';
          fichaTablero.style.backgroundColor = color;
          fichaTablero.textContent = fichaNum;
          fichaTablero.dataset.id = fichaId;
          fichaTablero.dataset.forma = jugadorFicha === 1 ? formaJugador1.value : formaJugador2.value;
          
          // Colocar ficha en el tablero
          posicionesTablero[pos].appendChild(fichaTablero);
          
          // Marcar ficha como colocada
          const fichaMano = document.querySelector(`[data-id="${fichaId}"]`);
          if (fichaMano) {
            fichaMano.style.opacity = '0.5';
            fichaMano.classList.add('ficha-en-tablero');
          }
        }
        
        // Si hay ganador, resaltar la combinaci贸n ganadora
        if (ganador) {
          for (const combinacion of combinacionesGanadoras) {
            // Obtener las fichas en las posiciones de la combinaci贸n
            const fichas = combinacion.map(pos => tablero[pos]);
            
            // Verificar si todas las posiciones tienen fichas
            if (fichas.includes(null)) {
              continue;
            }
            
            // Verificar si todas las fichas son del mismo jugador
            const jugadores = new Set(fichas.map(ficha => ficha.split('-')[0]));
            
            if (jugadores.size === 1 && Array.from(jugadores)[0] === ganador.toString()) {
              combinacion.forEach(pos => {
                const ficha = posicionesTablero[pos].querySelector('.ficha-tablero');
                if (ficha) {
                  ficha.style.boxShadow = '0 0 10px 3px gold';
                }
              });
              break;
            }
          }
        }
        
        // Iniciar timer cuando el estado del juego se actualiza
        startTimer();
      }
      
      // Actualizar estado de los jugadores desde Firebase
      function actualizarEstadoJugadores(jugadores) {
        // Actualizar estado de conexi贸n
        jugador1Status.className = jugadores[1].conectado ? 'jugador-online' : 'jugador-offline';
        jugador2Status.className = jugadores[2]?.conectado ? 'jugador-online' : 'jugador-offline';
        
        // Actualizar colores de las fichas
        if (jugadores[1].color !== colorJugador1.value) {
          colorJugador1.value = jugadores[1].color;
          actualizarColorJugador(1, jugadores[1].color);
        }
        
        if (jugadores[2] && jugadores[2].color !== colorJugador2.value) {
          colorJugador2.value = jugadores[2].color;
          actualizarColorJugador(2, jugadores[2].color);
        }

        // Actualizar formas de las fichas
        if (jugadores[1].forma !== formaJugador1.value) {
          formaJugador1.value = jugadores[1].forma;
          actualizarFormaJugador(1, jugadores[1].forma);
        }

        if (jugadores[2] && jugadores[2].forma !== formaJugador2.value) {
          formaJugador2.value = jugadores[2].forma;
          actualizarFormaJugador(2, jugadores[2].forma);
        }
        
        // Actualizar estado de espectador
        jugador1Espectador.style.display = jugadores[1].espectador ? 'inline' : 'none';
        if (jugadores[2]) {
          jugador2Espectador.style.display = jugadores[2].espectador ? 'inline' : 'none';
        }
      }
      
      // Actualizar el color de un jugador
      function actualizarColorJugador(jugador, color) {
        // Actualizar color de fichas en mano
        const fichas = document.querySelectorAll(`.jugador-${jugador} .ficha`);
        fichas.forEach(ficha => {
          ficha.style.backgroundColor = color;
        });
        
        // Actualizar color de fichas en tablero
        posicionesTablero.forEach((pos, index) => {
          if (tablero[index] && tablero[index].split('-')[0] === jugador.toString()) {
            const ficha = pos.querySelector('.ficha-tablero');
            if (ficha) {
              ficha.style.backgroundColor = color;
            }
          }
        });
      }

      // Actualizar la forma de un jugador
      function actualizarFormaJugador(jugador, forma) {
        // Actualizar forma de fichas en mano
        const fichas = document.querySelectorAll(`.jugador-${jugador} .ficha`);
        fichas.forEach(ficha => {
          ficha.dataset.forma = forma; // Store the shape as a data attribute
        });

        // Actualizar forma de fichas en tablero
        posicionesTablero.forEach((pos, index) => {
          if (tablero[index] && tablero[index].split('-')[0] === jugador.toString()) {
            const ficha = pos.querySelector('.ficha-tablero');
            if (ficha) {
              ficha.dataset.forma = forma; // Store the shape as a data attribute
            }
          }
        });
      }
      
      // Sincronizar estado del juego con Firebase
      function sincronizarEstadoJuego() {
        console.log("Sincronizando estado:", {
          turnoJugador,
          tablero,
          faseMover,
          fichasColocadasJ1,
          fichasColocadasJ2,
          ganador
        });
        
        database.ref('salas/' + salaId + '/estado').set({
          turnoJugador: turnoJugador,
          tablero: tablero,
          faseMover: faseMover,
          fichasColocadasJ1: fichasColocadasJ1,
          fichasColocadasJ2: fichasColocadasJ2,
          ganador: ganador
        }).then(() => {
          console.log("Estado sincronizado correctamente");
        }).catch(error => {
          console.error("Error al sincronizar estado:", error);
          mensaje.textContent = "Error de sincronizaci贸n. Intenta de nuevo.";
        });
      }
      
      // Verificar si una ficha tiene movimientos v谩lidos
      function tieneFichaMovimientosValidos(fichaId) {
        // Encontrar la posici贸n de la ficha
        let posicionFicha = -1;
        for (let i = 0; i < tablero.length; i++) {
          if (tablero[i] === fichaId) {
            posicionFicha = i;
            break;
          }
        }
        
        if (posicionFicha !== -1) {
          // Verificar si tiene posiciones adyacentes vac铆as
          const posicionesValidas = mapaAdyacencia[posicionFicha].filter(pos => tablero[pos] === null);
          return posicionesValidas.length > 0;
        }
        
        return false;
      }
      
      // Verificar si alguna ficha del jugador actual tiene movimientos v谩lidos
      function verificarFichasConMovimientos() {
        // Obtener las fichas del jugador actual en el tablero
        const fichasJugador = [];
        for (let i = 0; i < tablero.length; i++) {
          if (tablero[i] && tablero[i].startsWith(turnoJugador + '-')) {
            fichasJugador.push(tablero[i]);
          }
        }
        
        // Verificar si alguna ficha tiene movimientos v谩lidos
        return fichasJugador.some(fichaId => tieneFichaMovimientosValidos(fichaId));
      }
      
      // Modificar la funci贸n verificarGanador
      function verificarGanador() {
        for (const combinacion of combinacionesGanadoras) {
          const pos1 = combinacion[0];
          const pos2 = combinacion[1];
          const pos3 = combinacion[2];
          
          if (tablero[pos1] && tablero[pos2] && tablero[pos3]) {
            const jugador1 = tablero[pos1].split('-')[0];
            const jugador2 = tablero[pos2].split('-')[0];
            const jugador3 = tablero[pos3].split('-')[0];
            
            if (jugador1 === jugador2 && jugador2 === jugador3) {
              const gameTime = 30 - timeLeft;
              const moves = faseMover ? fichasColocadasJ1 + fichasColocadasJ2 : 3;
              
              if (!esEspectador) {
                // Obtener UID del otro jugador
                database.ref('salas/' + salaId + '/jugadores').once('value')
                  .then(snapshot => {
                    const jugadores = snapshot.val();
                    const jugadorGanador = parseInt(jugador1);
                    const uidGanador = jugadores[jugadorGanador].uid;
                    const uidPerdedor = jugadores[jugadorGanador === 1 ? 2 : 1].uid;

                    // Actualizar estad铆sticas del ganador
                    updateUserStats(uidGanador, true, gameTime, moves);
                    
                    // Actualizar estad铆sticas del perdedor
                    updateUserStats(uidPerdedor, false, gameTime, moves);
                    
                    // Actualizar tabla de ranking
                    updateRankingTable();
                  });
              }
              return parseInt(jugador1);
            }
          }
        }
        
        return null;
      }
      
      // Limpiar selecci贸n de posici贸n
      function limpiarSeleccionPosicion() {
        posicionesTablero.forEach(pos => {
          pos.classList.remove('posicion-valida', 'posicion-seleccionada');
        });
      }
      
      // Mostrar posiciones v谩lidas para colocar ficha
      function mostrarPosicionesValidasColocacion() {
        limpiarSeleccionPosicion();
        
        // Verificar que posicionesTablero y tablero est茅n definidos
        if (!posicionesTablero || !tablero) {
            console.error("posicionesTablero o tablero no est谩n definidos");
            return;
        }
        
        // Durante la fase de colocaci贸n, todas las posiciones vac铆as son v谩lidas
        posicionesTablero.forEach((pos, i) => {
            if (i < tablero.length && tablero[i] === null) {
            pos.classList.add('posicion-valida');
            }
        });
        }
      
      // Mostrar posiciones v谩lidas para mover ficha
      function mostrarPosicionesValidasMovimiento(fichaId) {
        limpiarSeleccionPosicion();
        
        // Encontrar la posici贸n actual de la ficha
        let posicionActual = -1;
        for (let i = 0; i < tablero.length; i++) {
          if (tablero[i] === fichaId) {
            posicionActual = i;
            break;
          }
        }
        
        if (posicionActual !== -1) {
          // Mostrar posiciones adyacentes que est茅n vac铆as
          const adyacentes = mapaAdyacencia[posicionActual];
          for (const pos of adyacentes) {
            if (tablero[pos] === null) {
              posicionesTablero[pos].classList.add('posicion-valida');
            }
          }
        }
      }
      
      // Manejar selecci贸n de ficha
      function seleccionarFicha(ficha) {
        // Solo permitir selecci贸n si es mi turno y no hay ganador
        if (!miTurno || ganador) return;
        
        const fichaId = ficha.dataset.id;
        const jugadorFicha = parseInt(fichaId.split('-')[0]);
        
        // Verificar que sea una ficha del jugador actual
        if (jugadorFicha !== turnoJugador) return;
        
        // Verificar que la ficha no est茅 ya en el tablero durante la fase de colocaci贸n
        if (!faseMover && ficha.classList.contains('ficha-en-tablero')) return;
        
        // En fase de movimiento, solo permitir seleccionar fichas en el tablero
        if (faseMover && !ficha.classList.contains('ficha-en-tablero')) return;
        
        // En fase de movimiento, verificar que la ficha tenga movimientos v谩lidos
        if (faseMover && !tieneFichaMovimientosValidos(fichaId)) {
          ficha.classList.add('sin-movimientos');
          setTimeout(() => {
            ficha.classList.remove('sin-movimientos');
          }, 1000);
          return;
        }
        
        // Limpiar selecci贸n anterior
        if (fichaSeleccionada) {
          fichaSeleccionada.classList.remove('ficha-seleccionada');
        }
        
        // Seleccionar nueva ficha
        ficha.classList.add('ficha-seleccionada');
        fichaSeleccionada = ficha;
        
        // Mostrar posiciones v谩lidas
        if (faseMover) {
          mostrarPosicionesValidasMovimiento(fichaId);
        } else {
          mostrarPosicionesValidasColocacion();
        }
      }
      
      // Manejar colocaci贸n o movimiento de ficha
      function colocarOMoveFicha(pos) {
        // Verificar que haya una ficha seleccionada y sea una posici贸n v谩lida
        if (!fichaSeleccionada || !pos.classList.contains('posicion-valida')) return;
        
        const posIndex = parseInt(pos.dataset.pos);
        const fichaId = fichaSeleccionada.dataset.id;
        
        // En fase de movimiento, eliminar la ficha de su posici贸n anterior
        if (faseMover) {
          for (let i = 0; i < tablero.length; i++) {
            if (tablero[i] === fichaId) {
              tablero[i] = null;
              break;
            }
          }
        }
        
        // Colocar la ficha en la nueva posici贸n
        tablero[posIndex] = fichaId;
        
        // Actualizar contadores de fichas colocadas
        if (!faseMover) {
          if (turnoJugador === 1) {
            fichasColocadasJ1++;
          } else {
            fichasColocadasJ2++;
          }
          
          // Verificar si pasamos a fase de movimiento
          if (fichasColocadasJ1 === 3 && fichasColocadasJ2 === 3) {
            faseMover = true;
          }
        }
        
        // Verificar si hay ganador
        ganador = verificarGanador();
        
        // Cambiar turno si no hay ganador
        if (!ganador) {
          turnoJugador = turnoJugador === 1 ? 2 : 1;
          
          // Si el siguiente jugador no tiene movimientos v谩lidos, regresa el turno
          if (faseMover && !verificarFichasConMovimientos()) {
            // Solo anunciar esto si ambos jugadores est谩n conectados
            if (jugador1Status.classList.contains('jugador-online') && 
                jugador2Status.classList.contains('jugador-online')) {
              mensaje.textContent = `隆Jugador ${turnoJugador} sin movimientos v谩lidos! Turno de Jugador ${turnoJugador === 1 ? 2 : 1}`;
              setTimeout(() => {
                turnoJugador = turnoJugador === 1 ? 2 : 1;
                mensaje.textContent = `Turno del Jugador ${turnoJugador}`;
                sincronizarEstadoJuego();
              }, 2000);
              return;
            }
          }
        }
        
        // Sincronizar con Firebase
        sincronizarEstadoJuego();
      }
      
      // Iniciar juego
      function iniciarJuego() {
        // Agregar listeners a las fichas del jugador 1
        fichasJugador1.forEach(ficha => {
          ficha.addEventListener('click', function() {
            seleccionarFicha(this);
          });
        });
        
        // Agregar listeners a las fichas del jugador 2
        fichasJugador2.forEach(ficha => {
          ficha.addEventListener('click', function() {
            seleccionarFicha(this);
          });
        });
        
        // Agregar listeners a las posiciones del tablero
        posicionesTablero.forEach(pos => {
          pos.addEventListener('click', function() {
            if (miTurno && fichaSeleccionada) {
              colocarOMoveFicha(this);
            }
          });
        });
        
        // Listener para cambio de color del jugador 1
        colorJugador1.addEventListener('change', function() {
          if (jugadorNum === 1 && !esEspectador) {
            database.ref('salas/' + salaId + '/jugadores/1/color').set(this.value);
          }
        });
        
        // Listener para cambio de color del jugador 2
        colorJugador2.addEventListener('change', function() {
          if (jugadorNum === 2 && !esEspectador) {
            database.ref('salas/' + salaId + '/jugadores/2/color').set(this.value);
          }
        });
        
        // Listener para cambio de forma del jugador 1
        formaJugador1.addEventListener('change', function() {
          if (jugadorNum === 1 && !esEspectador) {
            database.ref('salas/' + salaId + '/jugadores/1/forma').set(this.value);
          }
        });
        
        // Listener para cambio de forma del jugador 2
        formaJugador2.addEventListener('change', function() {
          if (jugadorNum === 2 && !esEspectador) {
            database.ref('salas/' + salaId + '/jugadores/2/forma').set(this.value);
          }
        });
        
        // Listener para reiniciar juego
        btnReiniciar.addEventListener('click', function() {
          if (esEspectador) return;
          
          // Reiniciar variables
          turnoJugador = 1;
          tablero = Array(9).fill(null);
          faseMover = false;
          fichasColocadasJ1 = 0;
          fichasColocadasJ2 = 0;
          ganador = null;
          
          // Sincronizar con Firebase
          sincronizarEstadoJuego();
        });
      }
      
      // Event Listeners para los botones de conexi贸n
      
      // Reset timer when game is reset
      function resetTimer() {
        clearInterval(timerInterval);
        timeLeft = 30;
        updateTimerDisplay();
      }
      
      crearSalaBtn.addEventListener('click', crearSala);
      
      unirseSalaBtn.addEventListener('click', function() {
        conexionOpciones.style.display = 'none';
        unirseForm.style.display = 'block';
      });
      
      btnUnirse.addEventListener('click', function() {
        const codigo = inputCodigo.value.trim();
        if (codigo.length === 6) {
          unirseASala(codigo);
        } else {
          conexionMensaje.textContent = "El c贸digo debe tener 6 caracteres.";
        }
      });
      
      copiarCodigoBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(codigoSala.textContent)
          .then(() => {
            this.textContent = "隆Copiado!";
            setTimeout(() => {
              this.textContent = "Copiar c贸digo";
            }, 2000);
          });
      });

      // Manejar cierre/recarga de p谩gina
      window.addEventListener('beforeunload', function() {
        if (salaId) {
            // Desconectar listeners
            database.ref('salas/' + salaId + '/estado').off();
            database.ref('salas/' + salaId + '/jugadores').off();
            
            // Si es jugador, marcar como desconectado y terminar la sala
            if (jugadorNum === 1 || jugadorNum === 2) {
                database.ref('salas/' + salaId + '/jugadores/' + jugadorNum + '/conectado').set(false);
                database.ref('salas/' + salaId + '/estado/terminada').set(true);
            }
        }
      });

      // Funciones para estad铆sticas
      function initializeUserStats(userId) {
        database.ref('users/' + userId + '/stats').once('value')
          .then(snapshot => {
            if (!snapshot.exists()) {
              return database.ref('users/' + userId + '/stats').set({
                victories: 0,
                defeats: 0,
                totalMoves: 0,
                totalTime: 0,
                gamesPlayed: 0
              });
            }
          });
      }

      // Modificar updateUserStats para manejar el tiempo del jugador actual
      function updateUserStats(userId, isVictory, gameTime, moves) {
        database.ref('users/' + userId + '/stats').transaction(stats => {
          if (stats === null) stats = {};
          
          const playerTime = isVictory ? gameTime : (30 - gameTime); // El perdedor us贸 el tiempo restante
          
          stats.victories = (stats.victories || 0) + (isVictory ? 1 : 0);
          stats.defeats = (stats.defeats || 0) + (isVictory ? 0 : 1);
          stats.totalMoves = (stats.totalMoves || 0) + moves;
          stats.totalTime = (stats.totalTime || 0) + playerTime;
          stats.gamesPlayed = (stats.gamesPlayed || 0) + 1;
          
          return stats;
        });
      }

      function loadUserStats(userId) {
        database.ref('users/' + userId + '/stats').on('value', snapshot => {
          const stats = snapshot.val() || {};
          document.getElementById('stats-victories').textContent = stats.victories || 0;
          document.getElementById('stats-defeats').textContent = stats.defeats || 0;
          
          // Calcular tiempo promedio solo con el tiempo real jugado
          const avgTime = stats.gamesPlayed ? 
            Math.round(stats.totalTime / (stats.victories + stats.defeats)) : 0;
          document.getElementById('stats-avg-time').textContent = avgTime + 's';
        });
      }

      function updateRankingTable() {
        database.ref('users').orderByChild('stats/victories').limitToLast(10).once('value')
          .then(snapshot => {
            const users = [];
            snapshot.forEach(child => {
              users.push({
                username: child.val().username,
                stats: child.val().stats || {}
              });
            });

            const tableBody = document.getElementById('ranking-table-body');
            tableBody.innerHTML = '';
            
            users.reverse().forEach((user, index) => {
              const ratio = user.stats.victories / (user.stats.gamesPlayed || 1);
              const row = `
                <tr>
                  <td>${index + 1}</td>
                  <td>${user.username}</td>
                  <td>${user.stats.victories || 0}</td>
                  <td>${user.stats.defeats || 0}</td>
                  <td>${ratio.toFixed(2)}</td>
                </tr>
              `;
              tableBody.innerHTML += row;
            });
          });
      }

      function setupChatAndEmotes() {
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatMessages = document.getElementById('chat-messages');
        const emoteButtons = document.querySelectorAll('.emote-btn');

        // Referencia al chat en Firebase
        const chatRef = database.ref('salas/' + salaId + '/chat');

        // Escuchar nuevos mensajes
        chatRef.on('child_added', (snapshot) => {
          const message = snapshot.val();
          const messageElement = document.createElement('div');
          messageElement.className = 'chat-message';
          messageElement.textContent = `${message.username}: ${message.text}`;
          chatMessages.appendChild(messageElement);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // Enviar mensaje
        function sendMessage() {
          const text = chatInput.value.trim();
          if (text && auth.currentUser) {
            database.ref('users/' + auth.currentUser.uid).once('value')
              .then(snapshot => {
                const username = snapshot.val().username;
                return chatRef.push({
                  username: username,
                  text: text,
                  timestamp: firebase.database.ServerValue.TIMESTAMP
                });
              })
              .then(() => {
                chatInput.value = '';
              });
          }
        }

        // Event listeners para chat
        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') sendMessage();
        });

        // Event listeners para emotes
        emoteButtons.forEach(button => {
          button.addEventListener('click', () => {
            const emote = button.dataset.emote;
            
            // Mostrar popup del emote
            const popup = document.createElement('div');
            popup.className = 'emote-popup';
            popup.textContent = emote;
            popup.style.left = `${button.offsetLeft}px`;
            popup.style.top = `${button.offsetTop - 40}px`;
            document.body.appendChild(popup);

            // Enviar emote al chat
            if (auth.currentUser) {
              database.ref('users/' + auth.currentUser.uid).once('value')
                .then(snapshot => {
                  const username = snapshot.val().username;
                  return chatRef.push({
                    username: username,
                    text: emote,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                  });
                });
            }

            // Remover popup despu茅s de la animaci贸n
            setTimeout(() => popup.remove(), 1000);
          });
        });
      }
    });
  </script>
</body>
</html>
